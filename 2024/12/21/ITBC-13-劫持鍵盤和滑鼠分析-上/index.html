<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ITBC 13 劫持鍵盤和滑鼠分析 (上) | mtkiao's blog</title>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="keywords" content="">
  <meta name="theme-color" content="#10b981">

  <link rel="canonical" href="http://example.com/2024/12/21/ITBC-13-%E5%8A%AB%E6%8C%81%E9%8D%B5%E7%9B%A4%E5%92%8C%E6%BB%91%E9%BC%A0%E5%88%86%E6%9E%90-%E4%B8%8A/">

  <link rel="shortcut icon" href="/">

  
  
<link rel="stylesheet" href="/css/main.css">


  
  <meta name="description" content="製作起因每次我去上應用軟體實習和程式設計實習的時候，我都很好奇他是怎麼劫持鍵盤和滑鼠的輸入的，不管是Ctrl+shift+del或Ctrl+shift+ese或移動滑鼠都沒有任何反應…然後我就猜他是透過驅動在Ring0層Hook輸入或是filter輸入，所以我去ITBC的文件夾下搜尋*.sys後… 還真讓我找到了一個驅動文件: KbFilter.sys，然後我去看了filter驅動列表，然後我又看">
<meta property="og:type" content="article">
<meta property="og:title" content="ITBC 13 劫持鍵盤和滑鼠分析 (上)">
<meta property="og:url" content="http://example.com/2024/12/21/ITBC-13-%E5%8A%AB%E6%8C%81%E9%8D%B5%E7%9B%A4%E5%92%8C%E6%BB%91%E9%BC%A0%E5%88%86%E6%9E%90-%E4%B8%8A/index.html">
<meta property="og:site_name" content="mtkiao&#39;s blog">
<meta property="og:description" content="製作起因每次我去上應用軟體實習和程式設計實習的時候，我都很好奇他是怎麼劫持鍵盤和滑鼠的輸入的，不管是Ctrl+shift+del或Ctrl+shift+ese或移動滑鼠都沒有任何反應…然後我就猜他是透過驅動在Ring0層Hook輸入或是filter輸入，所以我去ITBC的文件夾下搜尋*.sys後… 還真讓我找到了一個驅動文件: KbFilter.sys，然後我去看了filter驅動列表，然後我又看">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/ITBC13Driver.png">
<meta property="article:published_time" content="2024-12-21T13:33:50.000Z">
<meta property="article:modified_time" content="2024-12-22T06:54:37.403Z">
<meta property="article:author" content="mtkiao">
<meta property="article:tag" content="Reverse">
<meta property="article:tag" content="Kernel">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/ITBC13Driver.png">

  <style>
    :root {
      --sea-color-primary: #10b981;
    }
  </style>

  
<script src="/js/theme_mode.js"></script>

<meta name="generator" content="Hexo 7.3.0"></head>
<body>
  <header class="sea-header">
    <nav class="sea-nav-wrap">
  <h1 class="sea-nav-logo" title="blogs">
    <a href="/">mtkiao's blog</a>
  </h1>
  <div class="sea-nav-menus">
    <div id="sea-nav-toggle">
      <svg t="1716965724278" class="sea-svg-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="10878" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M950.857143 768v73.142857c0 20.004571-16.566857 36.571429-36.571429 36.571429H109.714286c-20.004571 0-36.571429-16.566857-36.571429-36.571429v-73.142857c0-20.004571 16.566857-36.571429 36.571429-36.571429h804.571428c20.004571 0 36.571429 16.566857 36.571429 36.571429z m0-292.571429v73.142858c0 20.004571-16.566857 36.571429-36.571429 36.571428H109.714286c-20.004571 0-36.571429-16.566857-36.571429-36.571428v-73.142858c0-20.004571 16.566857-36.571429 36.571429-36.571428h804.571428c20.004571 0 36.571429 16.566857 36.571429 36.571428z m0-292.571428v73.142857c0 20.004571-16.566857 36.571429-36.571429 36.571429H109.714286c-20.004571 0-36.571429-16.566857-36.571429-36.571429V182.857143c0-20.004571 16.566857-36.571429 36.571429-36.571429h804.571428c20.004571 0 36.571429 16.566857 36.571429 36.571429z" p-id="10879"></path></svg>
    </div>

    <div class="sea-menu-wrap">
  
    <a
      class="sea-menu-link"
      
      href="/blogs"
    >
      Blogs
    </a>
  
    <a
      class="sea-menu-link"
      
      href="/categories"
    >
      Categories
    </a>
  
    <a
      class="sea-menu-link"
      
      href="/tags"
    >
      Tags
    </a>
  
    <a
      class="sea-menu-link"
      
      href="/about"
    >
      About
    </a>
  

  <span class="sea-menu-sep">|</span>

  

  <span class="sea-menu-icon" id="sea-theme-dark">
    <svg t="1725413107294" class="sea-svg-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="10118" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M557.553778 976.355556c-257.265778 0-466.56-207.160889-466.56-464.426667 0-253.923556 206.577778-464.284444 460.501333-464.284445h0.355556c10.766222 0 20.622222 3.953778 25.443555 13.610667 4.878222 9.756444 3.740444 20.394667-2.915555 29.027556-55.722667 72.220444-85.162667 158.108444-85.162667 249.372444 0 225.891556 183.779556 409.386667 409.671111 409.386667l5.248-0.256c10.325333-0.142222 20.977778 5.859556 25.841778 15.644444a28.302222 28.302222 0 0 1-2.915556 30.051556C837.902222 910.08 703.203556 976.355556 557.553778 976.355556zM495.274667 105.016889C299.192889 135.281778 147.882667 306.161778 147.882667 509.809778c0 225.877333 183.779556 409.656889 409.671111 409.656889 108.686222 0 210.403556-42.055111 286.577778-116.977778-231.566222-27.192889-411.804444-224.625778-411.804445-463.36 0-83.427556 21.617778-163.299556 62.947556-234.112z" fill="" p-id="10119"></path><path d="M578.830222 879.132444c-186.865778 0-345.784889-133.418667-377.841778-317.269333a14.222222 14.222222 0 1 1 28.017778-4.878222c29.681778 170.183111 176.810667 293.703111 349.824 293.703111a14.222222 14.222222 0 1 1 0 28.444444zM209.991111 531.2c-7.537778 0-13.838222-6.997333-14.193778-14.606222-0.312889-6.584889-0.483556-13.795556-0.483555-20.465778 0-7.864889 6.357333-14.492444 14.222222-14.492444s14.222222 6.229333 14.222222 14.094222c0 6.229333 0.170667 13.425778 0.455111 19.584 0.369778 7.850667-5.674667 15.886222-13.525333 15.886222h-0.696889z" fill="" p-id="10120"></path><path d="M622.350222 309.930667m-25.344 0a25.344 25.344 0 1 0 50.688 0 25.344 25.344 0 1 0-50.688 0Z" fill="" p-id="10121"></path><path d="M787.072 188.273778m-25.344 0a25.344 25.344 0 1 0 50.688 0 25.344 25.344 0 1 0-50.688 0Z" fill="" p-id="10122"></path><path d="M731.960889 415.303111m-25.344 0a25.344 25.344 0 1 0 50.688 0 25.344 25.344 0 1 0-50.688 0Z" p-id="10123"></path></svg>
  </span>
  <span class="sea-menu-icon" id="sea-theme-light">
    <svg t="1725410359322" class="sea-svg-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4274" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M512 768c-141.376 0-256-114.624-256-256s114.624-256 256-256 256 114.624 256 256-114.624 256-256 256z m0-85.333333a170.666667 170.666667 0 1 0 0-341.333334 170.666667 170.666667 0 0 0 0 341.333334zM469.333333 85.333333a42.666667 42.666667 0 1 1 85.333334 0v85.333334a42.666667 42.666667 0 1 1-85.333334 0V85.333333z m0 768a42.666667 42.666667 0 1 1 85.333334 0v85.333334a42.666667 42.666667 0 1 1-85.333334 0v-85.333334zM85.333333 554.666667a42.666667 42.666667 0 1 1 0-85.333334h85.333334a42.666667 42.666667 0 1 1 0 85.333334H85.333333z m768 0a42.666667 42.666667 0 1 1 0-85.333334h85.333334a42.666667 42.666667 0 1 1 0 85.333334h-85.333334zM161.834667 222.165333a42.666667 42.666667 0 0 1 60.330666-60.330666l64 64a42.666667 42.666667 0 0 1-60.330666 60.330666l-64-64z m576 576a42.666667 42.666667 0 0 1 60.330666-60.330666l64 64a42.666667 42.666667 0 0 1-60.330666 60.330666l-64-64z m-515.669334 64a42.666667 42.666667 0 0 1-60.330666-60.330666l64-64a42.666667 42.666667 0 0 1 60.330666 60.330666l-64 64z m576-576a42.666667 42.666667 0 0 1-60.330666-60.330666l64-64a42.666667 42.666667 0 0 1 60.330666 60.330666l-64 64z" p-id="4275"></path></svg>
  </span>

  <span id="sea-menu-close-icon">
    <svg t="1725435896874" class="sea-svg-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4408" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M556.8 512l265.6-265.6c12.8-12.8 12.8-32 0-44.8s-32-12.8-44.8 0L512 467.2 246.4 201.6c-12.8-12.8-32-12.8-44.8 0s-12.8 32 0 44.8l265.6 265.6-265.6 265.6c-12.8 12.8-12.8 32 0 44.8 6.4 6.4 12.8 9.6 22.4 9.6s16-3.2 22.4-9.6l265.6-265.6 265.6 265.6c6.4 6.4 16 9.6 22.4 9.6s16-3.2 22.4-9.6c12.8-12.8 12.8-32 0-44.8L556.8 512z" p-id="4409"></path></svg>
  </span>
</div>
<div id="sea-nav-dimmer"></div>
  </div>
</nav>
  </header>
  <main id="sea-main-wrapper">
    <article class="sea-page-card-wrapper">
  <header class="sea-article-header">
    <h1 class="sea-article-title">ITBC 13 劫持鍵盤和滑鼠分析 (上)</h1>
    
      <div class="sea-post-meta sea-post-meta__center">
        <div class="sea-post-time">
  <svg t="1716964550804" class="sea-svg-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2621" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M805.49888 981.49888l-602.3168-0.76288c-86.59456-8.192-154.56768-81.3056-154.56768-170.01472L48.6144 291.73248c0-94.1568 76.60032-170.75712 170.7776-170.75712l586.10176 0c94.1568 0 170.73152 76.60032 170.73152 170.75712L976.22528 810.7008C976.2304 904.87296 899.63008 981.49888 805.49888 981.49888L805.49888 981.49888zM219.3664 190.57152c-55.79776 0-101.20192 45.38368-101.20192 101.18144l0 518.96832c0 55.79776 45.40416 101.20704 101.20192 101.20704l586.13248 0c55.77728 0 101.16096-45.40928 101.16096-101.20704L906.65984 291.73248c0-55.79776-45.38368-101.18656-101.16096-101.18656L219.3664 190.54592 219.3664 190.57152zM698.84416 290.51904c-25.60512 0-46.38208-20.77696-46.38208-46.38208l0-158.6688c0-25.6 20.77696-46.38208 46.38208-46.38208 25.6 0 46.38208 20.78208 46.38208 46.38208L745.22624 244.1216C745.22624 269.7472 724.46976 290.51904 698.84416 290.51904L698.84416 290.51904zM315.65824 290.51904c-25.60512 0-46.38208-20.77696-46.38208-46.38208l0-158.6688c0-25.6 20.77696-46.38208 46.38208-46.38208 25.6 0 46.38208 20.78208 46.38208 46.38208L362.04032 244.1216C362.04032 269.7472 341.28896 290.51904 315.65824 290.51904L315.65824 290.51904zM534.8864 794.78784l-44.27264 0c-25.6 0-46.38208-20.77696-46.38208-46.38208 0-25.6 20.78208-46.38208 46.38208-46.38208l44.27264 0c25.6 0 46.38208 20.78208 46.38208 46.38208C581.26848 774.01088 560.4864 794.78784 534.8864 794.78784L534.8864 794.78784zM930.79552 452.608 121.24672 452.608c-25.60512 0-46.38208-20.78208-46.38208-46.38208 0-25.60512 20.77696-46.38208 46.38208-46.38208l809.5744 0c25.6 0 46.38208 20.77696 46.38208 46.38208C977.2032 431.82592 956.42624 452.608 930.79552 452.608L930.79552 452.608zM327.92576 649.03168l-44.27264 0c-25.6 0-46.38208-20.78208-46.38208-46.38208 0-25.60512 20.78208-46.38208 46.38208-46.38208l44.27264 0c25.6 0 46.38208 20.77696 46.38208 46.38208C374.30784 628.25472 353.52576 649.03168 327.92576 649.03168L327.92576 649.03168zM534.8864 649.03168l-44.27264 0c-25.6 0-46.38208-20.78208-46.38208-46.38208 0-25.60512 20.78208-46.38208 46.38208-46.38208l44.27264 0c25.6 0 46.38208 20.77696 46.38208 46.38208S560.4864 649.03168 534.8864 649.03168L534.8864 649.03168zM741.27872 649.03168l-44.26752 0c-25.60512 0-46.38208-20.78208-46.38208-46.38208 0-25.60512 20.77696-46.38208 46.38208-46.38208l44.26752 0c25.60512 0 46.38208 20.77696 46.38208 46.38208C787.6608 628.25472 766.90944 649.03168 741.27872 649.03168L741.27872 649.03168zM327.92576 794.78784l-44.27264 0c-25.6 0-46.38208-20.77696-46.38208-46.38208 0-25.6 20.78208-46.38208 46.38208-46.38208l44.27264 0c25.6 0 46.38208 20.78208 46.38208 46.38208C374.30784 774.01088 353.52576 794.78784 327.92576 794.78784L327.92576 794.78784zM741.27872 794.78784l-44.26752 0c-25.60512 0-46.38208-20.77696-46.38208-46.38208 0-25.6 20.77696-46.38208 46.38208-46.38208l44.26752 0c25.60512 0 46.38208 20.78208 46.38208 46.38208C787.6608 774.01088 766.90944 794.78784 741.27872 794.78784L741.27872 794.78784z" p-id="2622"></path></svg>
  <time datetime="2024-12-21T13:33:50.000Z">2024-12-21</time>
</div>
        
  <div class="sea-post-categories">
    <svg t="1716964680422" class="sea-svg-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4550" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M810.666667 85.333333a85.333333 85.333333 0 0 1 85.333333 85.333334v152.021333c36.821333 9.493333 64 42.88 64 82.645333v405.333334a128 128 0 0 1-128 128H192a128 128 0 0 1-128-128V298.666667a85.376 85.376 0 0 1 64-82.645334V170.666667a85.333333 85.333333 0 0 1 85.333333-85.333334h597.333334zM128.149333 296.170667L128 298.666667v512a64 64 0 0 0 60.245333 63.893333L192 874.666667h640a64 64 0 0 0 63.893333-60.245334L896 810.666667V405.333333a21.333333 21.333333 0 0 0-18.837333-21.184L874.666667 384H638.165333l-122.069333-101.717333a21.333333 21.333333 0 0 0-10.688-4.736l-2.986667-0.213334H149.333333a21.333333 21.333333 0 0 0-21.184 18.837334zM535.189333 213.333333l127.978667 106.666667H832V170.666667a21.333333 21.333333 0 0 0-18.837333-21.184L810.666667 149.333333H213.333333a21.333333 21.333333 0 0 0-21.184 18.837334L192 170.666667v42.666666h343.168z" p-id="4551"></path></svg>
    <a class="category-link" href="/categories/Reverse/">Reverse</a>
  </div>

        
  <div class="sea-post-tags">
    <svg t="1716964811431" class="sea-svg-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6117" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M384 977.152c-20.5312 0-39.8336-7.9872-54.3232-22.4256l-260.4032-260.4032c-14.4896-14.4896-22.4256-33.7408-22.4256-54.3232s7.9872-39.8336 22.4256-54.3232l439.6032-439.6032c24.9344-24.9344 70.2464-43.7248 105.5232-43.7248h230.4c42.3424 0 76.8 34.4576 76.8 76.8v230.4c0 35.2256-18.7904 80.5888-43.6736 105.5232l-439.6032 439.6032a76.1856 76.1856 0 0 1-54.3232 22.4256zM614.4 153.6c-21.248 0-54.272 13.6704-69.2736 28.7232l-439.6032 439.6032c-4.8128 4.8128-7.424 11.2128-7.424 18.1248s2.6624 13.312 7.424 18.0736l260.4032 260.4032c4.8128 4.8128 11.2128 7.424 18.1248 7.424s13.312-2.6624 18.1248-7.424l439.6032-439.6032c15.0016-15.0016 28.7232-48.0768 28.7232-69.3248V179.2a25.6 25.6 0 0 0-25.6-25.6h-230.4z" p-id="6118"></path><path d="M742.4 358.4c-42.3424 0-76.8-34.4576-76.8-76.8S700.0576 204.8 742.4 204.8s76.8 34.4576 76.8 76.8S784.7424 358.4 742.4 358.4z m0-102.4a25.6 25.6 0 1 0 0 51.2 25.6 25.6 0 0 0 0-51.2z" p-id="6119"></path></svg>
    <a class="tag-link" href="/tags/Kernel/" rel="tag">Kernel</a> , <a class="tag-link" href="/tags/Reverse/" rel="tag">Reverse</a>
  </div>

      </div>
    
  </header>
  <div class="sea-article-content sea-doc">
    <h3 id="製作起因"><a href="#製作起因" class="headerlink" title="製作起因"></a>製作起因</h3><p>每次我去上應用軟體實習和程式設計實習的時候，我都很好奇他是怎麼劫持鍵盤和滑鼠的輸入的，不管是Ctrl+shift+del或Ctrl+shift+ese或移動滑鼠都沒有任何反應…<br>然後我就猜他是透過驅動在Ring0層Hook輸入或是filter輸入，所以我去ITBC的文件夾下搜尋*.sys後… 還真讓我找到了一個驅動文件: <code>KbFilter.sys</code>，然後我去看了filter驅動列表，然後我又看到了<code>KbFilter.sys</code>，而且類型是<code>KEYBOARD</code>，這就是鎖住鍵盤的關鍵文件!<br>因此，我就製作了這篇文章….</p>
<p>我們先來看看有哪些文件可能跟鎖鍵盤有關係:<br><code>...\ITBC13\KbFilter.sys</code> &#x3D;&gt; 驅動文件本體<br><code>...\ITBC13\KbDriver.exe</code> &#x3D;&gt; 貌似是驅動的安裝與卸載程式</p>
<p>然後是驅動文件簽名:<br><img src="/images/ITBC13Driver.png" alt="驅動簽名"></p>
<p>我很疑惑為甚麼是來自大陸的簽名，但這個應該不重要，還是先跳過吧…</p>
<h3 id="KbDriver-exe-代碼分析"><a href="#KbDriver-exe-代碼分析" class="headerlink" title="KbDriver.exe 代碼分析"></a>KbDriver.exe 代碼分析</h3><p>稍微翻了一下裡面的代碼後，我找到了主要的代碼:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">__int64 __fastcall <span class="token function">sub_10000196C</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">stricmp</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a2 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"/install"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// 判斷參數是否為 /install</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"start install\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">OutputDebugStringA</span><span class="token punctuation">(</span><span class="token string">"start install\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">sub_100001678</span><span class="token punctuation">(</span>L<span class="token string">"kbFilter"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>
      <span class="token function">sub_100001C10</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">stricmp</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a2 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"/uninstall"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// 判斷參數是否為 /uninstall</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">OutputDebugStringA</span><span class="token punctuation">(</span><span class="token string">"start uninstall\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">sub_1000017F0</span><span class="token punctuation">(</span>L<span class="token string">"kbFilter"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
      <span class="token function">sub_100001EF0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"no action\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token number">0</span>i64<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>稍微分析了裡面的函數後，我得出了以下的結論<br><strong>函數大致作用</strong><br><code>sub_100001678</code> &#x3D;&gt; 檢查是否可以安裝驅動<br><code>sub_100001C10</code> &#x3D;&gt; 先檢查服務是否不存在，然後再進行驅動安裝<br><code>sub_1000017F0</code> &#x3D;&gt; 檢查是否可以卸載驅動<br><code>sub_100001EF0</code> &#x3D;&gt; 先檢查服務是否存在，然後再進行驅動卸載</p>
<p>這程式應該的功能應該就管驅動的安裝或卸載這樣，<br>那先來看看sub_100001C10的代碼好了 </p>
<p><code>sub_100001C10</code>:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">__int64 <span class="token function">sub_100001C10</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  SC_HANDLE v0<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  DWORD v1<span class="token punctuation">;</span> <span class="token comment">// ebx</span>
  SC_HANDLE v2<span class="token punctuation">;</span> <span class="token comment">// rsi</span>
  SC_HANDLE v3<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment">// edi</span>
  <span class="token keyword">const</span> CHAR <span class="token operator">*</span>v5<span class="token punctuation">;</span> <span class="token comment">// rcx</span>
  <span class="token keyword">const</span> CHAR <span class="token operator">*</span>v7<span class="token punctuation">;</span> <span class="token comment">// rcx</span>
  __int64 v8<span class="token punctuation">;</span> <span class="token comment">// rcx</span>
  LSTATUS v9<span class="token punctuation">;</span> <span class="token comment">// eax</span>
  DWORD pcbData<span class="token punctuation">;</span> <span class="token comment">// [rsp+30h] [rbp-248h] BYREF</span>
  DWORD pdwType<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+34h] [rbp-244h] BYREF</span>
  <span class="token keyword">char</span> pvData<span class="token punctuation">[</span><span class="token number">272</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+40h] [rbp-238h] BYREF</span>
  CHAR OutputString<span class="token punctuation">[</span><span class="token number">272</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+150h] [rbp-128h] BYREF</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>OutputString<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">260</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">OutputDebugStringA</span><span class="token punctuation">(</span><span class="token string">"enter easyusb_install"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v0 <span class="token operator">=</span> <span class="token function">OpenSCManagerA</span><span class="token punctuation">(</span><span class="token number">0</span>i64<span class="token punctuation">,</span> <span class="token number">0</span>i64<span class="token punctuation">,</span> <span class="token number">983103u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  v2 <span class="token operator">=</span> v0<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v0 <span class="token punctuation">)</span>
    <span class="token keyword">goto</span> LABEL_7<span class="token punctuation">;</span>
  v3 <span class="token operator">=</span> <span class="token function">OpenServiceA</span><span class="token punctuation">(</span>v0<span class="token punctuation">,</span> <span class="token string">"KbFilter"</span><span class="token punctuation">,</span> <span class="token number">0xF01FFu</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    v4 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">CloseServiceHandle</span><span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">&#123;</span>
    v4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">CloseServiceHandle</span><span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    v5 <span class="token operator">=</span> <span class="token string">" EasyUsb_IsIntall failed \n"</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">&#123;</span>
LABEL_7<span class="token operator">:</span>
    <span class="token function">deleteDriverFileAndRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">copyDriverFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">OutputDebugStringA</span><span class="token punctuation">(</span><span class="token string">" CopyDriverFile failed \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token number">177</span>i64<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">OutputDebugStringA</span><span class="token punctuation">(</span><span class="token string">"COPYdriverfile ok!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>OutputString<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x104u</span>i64<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sub_100001A10</span><span class="token punctuation">(</span>OutputString<span class="token punctuation">,</span> <span class="token number">0x104u</span>i64<span class="token punctuation">,</span> <span class="token string">"system32\\drivers\\%s.sys"</span><span class="token punctuation">,</span> <span class="token string">"KbFilter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">OutputDebugStringA</span><span class="token punctuation">(</span>OutputString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">createDriverService</span><span class="token punctuation">(</span><span class="token string">"KbFilter"</span><span class="token punctuation">,</span> OutputString<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment">// 1 == create, 2 == delete</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">OutputDebugStringA</span><span class="token punctuation">(</span><span class="token string">" ManageDriver failed \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">createDriverService</span><span class="token punctuation">(</span><span class="token string">"KbFilter"</span><span class="token punctuation">,</span> <span class="token number">0</span>i64<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">OutputDebugStringA</span><span class="token punctuation">(</span><span class="token string">"error.remove driver\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token number">193</span>i64<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">OutputDebugStringA</span><span class="token punctuation">(</span><span class="token string">"manage driver success!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>pvData<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">260</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pcbData <span class="token operator">=</span> <span class="token number">260</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">SHGetValueA</span><span class="token punctuation">(</span>
           HKEY_LOCAL_MACHINE<span class="token punctuation">,</span>
           <span class="token string">"SYSTEM\\CurrentControlSet\\Control\\Class\\&#123;4D36E96B-E325-11CE-BFC1-08002BE10318&#125;"</span><span class="token punctuation">,</span>
           <span class="token string">"UpperFilters"</span><span class="token punctuation">,</span>
           pdwType<span class="token punctuation">,</span>
           pvData<span class="token punctuation">,</span>
           <span class="token operator">&amp;</span>pcbData<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      v7 <span class="token operator">=</span> <span class="token string">" SHGetValue 1 failed \n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">OutputDebugStringA</span><span class="token punctuation">(</span><span class="token string">"ShGetvalue1 oK!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      v7 <span class="token operator">=</span> pvData<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">OutputDebugStringA</span><span class="token punctuation">(</span>v7<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span>pvData<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      v8 <span class="token operator">=</span> pcbData<span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>pdwType<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> pcbData <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"KbFilter"</span><span class="token punctuation">;</span>
      pvData<span class="token punctuation">[</span>v8 <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> DisplayName<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      v1 <span class="token operator">=</span> pcbData<span class="token punctuation">;</span>
      pvData<span class="token punctuation">[</span>pcbData <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">memset</span><span class="token punctuation">(</span>pvData<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x104u</span>i64<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">strcpy</span><span class="token punctuation">(</span>pvData<span class="token punctuation">,</span> <span class="token string">"KbFilter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      pcbData <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    pdwType<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
    v9 <span class="token operator">=</span> <span class="token function">SHSetValueA</span><span class="token punctuation">(</span>
           HKEY_LOCAL_MACHINE<span class="token punctuation">,</span>
           <span class="token string">"SYSTEM\\CurrentControlSet\\Control\\Class\\&#123;4D36E96B-E325-11CE-BFC1-08002BE10318&#125;"</span><span class="token punctuation">,</span>
           <span class="token string">"UpperFilters"</span><span class="token punctuation">,</span>
           <span class="token number">7u</span><span class="token punctuation">,</span>
           pvData<span class="token punctuation">,</span>
           v1 <span class="token operator">+</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    v5 <span class="token operator">=</span> <span class="token string">" SHGetValue 1 failed \n"</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v9 <span class="token punctuation">)</span>
      v5 <span class="token operator">=</span> <span class="token string">"shgetvalue 1  ok\n"</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">OutputDebugStringA</span><span class="token punctuation">(</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span>i64<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>看代碼應該是把驅動移動到C:\Windows\System32\Drivers\這裡 (這樣才能被Windows自動加載) 然後創建服務，然後往註冊表路徑<code>HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Class\\&#123;4D36E96B-E325-11CE-BFC1-08002BE10318&#125;\\UpperFilters</code> 寫入值<code>KbFilter</code> </p>
<p>通常<code>HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Class\\</code>底下會處存硬件設備的GUID，而且每個GUID都對應的一種類型的設備，而這裡的<code>4D36E96B-E325-11CE-BFC1-08002BE10318</code>則是對應鍵盤的GUID</p>
<p>那這裡的<code>UpperFilters</code>的用途則是<code>設定這個設備的所有驅動</code>，原本的值設定為<code>kbdclass</code>，也就是說鍵盤會加載<code>kbdclass</code>這個名稱的驅動，運行這個安裝程式後則會被追加<code>KbFilter</code>，也就是說鍵盤會加載<code>kbdclass</code>和<code>KbFilter</code>這些名字的驅動，而<code>KbFilter</code>就是這個filter鍵盤輸入的驅動，會在驅動裡設定要攔截哪些鍵值，達成攔截鍵盤輸入的作用。</p>
<p>GUID定義參考來源: <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-tw/windows-hardware/drivers/install/system-defined-device-setup-classes-available-to-vendors">https://learn.microsoft.com/zh-tw/windows-hardware/drivers/install/system-defined-device-setup-classes-available-to-vendors</a></p>
<h3 id="KbDriver-sys-代碼分析"><a href="#KbDriver-sys-代碼分析" class="headerlink" title="KbDriver.sys 代碼分析"></a>KbDriver.sys 代碼分析</h3><p><code>KbDriver.exe</code>的代碼大致分析完了，我們接下來來看看<code>KbDriver.sys</code>的代碼，<br>我們先看看驅動的入口代碼:</p>
<p><code>DriverEntry</code>:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">NTSTATUS __stdcall <span class="token function">DriverEntry</span><span class="token punctuation">(</span>_DRIVER_OBJECT <span class="token operator">*</span>DriverObject<span class="token punctuation">,</span> PUNICODE_STRING RegistryPath<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  NTSTATUS v3<span class="token punctuation">;</span> <span class="token comment">// eax</span>
  NTSTATUS v4<span class="token punctuation">;</span> <span class="token comment">// edi</span>
  NTSTATUS v6<span class="token punctuation">;</span> <span class="token comment">// eax</span>
  <span class="token keyword">struct</span> <span class="token class-name">_UNICODE_STRING</span> DeviceName<span class="token punctuation">;</span> <span class="token comment">// [rsp+40h] [rbp-28h] BYREF</span>
  <span class="token keyword">struct</span> <span class="token class-name">_UNICODE_STRING</span> DestinationString<span class="token punctuation">;</span> <span class="token comment">// [rsp+50h] [rbp-18h] BYREF</span>
  PDEVICE_OBJECT DeviceObject<span class="token punctuation">;</span> <span class="token comment">// [rsp+70h] [rbp+8h] BYREF</span>

  <span class="token function">DbgPrint</span><span class="token punctuation">(</span>aCtrl2capSysEnt<span class="token punctuation">,</span> RegistryPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset64</span><span class="token punctuation">(</span>DriverObject<span class="token operator">-></span>MajorFunction<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int64<span class="token punctuation">)</span>sub_15198<span class="token punctuation">,</span> <span class="token number">0x1Bu</span>i64<span class="token punctuation">)</span><span class="token punctuation">;</span>
  DriverObject<span class="token operator">-></span>MajorFunction<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>PDRIVER_DISPATCH<span class="token punctuation">)</span>sub_11008<span class="token punctuation">;</span>
  DriverObject<span class="token operator">-></span>MajorFunction<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>PDRIVER_DISPATCH<span class="token punctuation">)</span>sub_11050<span class="token punctuation">;</span>
  DriverObject<span class="token operator">-></span>MajorFunction<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>PDRIVER_DISPATCH<span class="token punctuation">)</span>sub_113A8<span class="token punctuation">;</span>
  DriverObject<span class="token operator">-></span>MajorFunction<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>PDRIVER_DISPATCH<span class="token punctuation">)</span>sub_110AC<span class="token punctuation">;</span>
  DriverObject<span class="token operator">-></span>MajorFunction<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>PDRIVER_DISPATCH<span class="token punctuation">)</span><span class="token operator">&amp;</span>sub_1510C<span class="token punctuation">;</span>
  DriverObject<span class="token operator">-></span>MajorFunction<span class="token punctuation">[</span><span class="token number">27</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>PDRIVER_DISPATCH<span class="token punctuation">)</span>sub_15098<span class="token punctuation">;</span>
  DriverObject<span class="token operator">-></span>DriverUnload <span class="token operator">=</span> <span class="token punctuation">(</span>PDRIVER_UNLOAD<span class="token punctuation">)</span>sub_15150<span class="token punctuation">;</span><span class="token comment">// 處理驅動卸載</span>
  DriverObject<span class="token operator">-></span>DriverExtension<span class="token operator">-></span>AddDevice <span class="token operator">=</span> <span class="token punctuation">(</span>PDRIVER_ADD_DEVICE<span class="token punctuation">)</span><span class="token operator">&amp;</span>sub_15008<span class="token punctuation">;</span>
  <span class="token function">RtlInitUnicodeString</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DestinationString<span class="token punctuation">,</span> aDosdevicesOekb<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 初始化字串 \DosDevices\OeKbdFilter</span>
  <span class="token function">RtlInitUnicodeString</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DeviceName<span class="token punctuation">,</span> aDeviceDevoekbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 初始化字串 \Device\DevOeKbdFilter</span>
  v3 <span class="token operator">=</span> <span class="token function">IoCreateDevice</span><span class="token punctuation">(</span>DriverObject<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>DeviceName<span class="token punctuation">,</span> <span class="token number">0xBu</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>DeviceObject<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 0xBu創建一個鍵盤類型的設備(FILE_DEVICE_KEYBOARD)</span>
  v4 <span class="token operator">=</span> v3<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">DbgPrint</span><span class="token punctuation">(</span><span class="token string">"[HookDeviceIocontrol] Error, IoCreateDevice = 0x%x\r\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> v4<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  qword_13120 <span class="token operator">=</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>DeviceObject<span class="token punctuation">;</span>
  v6 <span class="token operator">=</span> <span class="token function">IoCreateSymbolicLink</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DestinationString<span class="token punctuation">,</span> <span class="token operator">&amp;</span>DeviceName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 創建符號連結\DosDevices\OeKbdFilter => \Device\DevOeKbdFilter</span>
  v4 <span class="token operator">=</span> v6<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v6 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">DbgPrint</span><span class="token punctuation">(</span><span class="token string">"[HookDeviceIocontrol] Error, IoCreateSymbolicLink = 0x%x\r\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>v6<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">IoDeleteDevice</span><span class="token punctuation">(</span>DeviceObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> v4<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  DeviceObject<span class="token operator">-></span>Flags <span class="token operator">|=</span> <span class="token number">0x2004u</span><span class="token punctuation">;</span>               <span class="token comment">// 設定可以處理IO請求和狀態</span>
  DeviceObject<span class="token operator">-></span>Flags <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token number">0x80u</span><span class="token punctuation">;</span>                <span class="token comment">// 清除初始化標誌</span>
  SpinLock <span class="token operator">=</span> <span class="token number">0</span>i64<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這段代碼在設定一些東西還有設定處理鍵盤的I&#x2F;O IRP要經過哪個函數，其中比較關鍵的是<code>DriverObject-&gt;MajorFunction[3] = (PDRIVER_DISPATCH)sub_113A8;</code>，這裡再設定收到<code>IRP_MJ_READ</code>IRP時要用哪個函數處理，在filter的KEYBOARD類的驅動，<code>IRP_MJ_READ</code>會收到鍵盤輸入的值，然後傳入<code>sub_113A8</code>進行處理，也就是說我們要找的東西就在這裡。<br>然後所有的IRP設定都列在下面:<br><code>MajorFunction[0]</code> &#x3D;&gt; <code>sub_11008</code> ; IRP_MJ_CREATE<br><code>MajorFunction[2]</code> &#x3D;&gt; <code>sub_11050</code> ; IRP_MJ_CLOSE<br><code>MajorFunction[3]</code> &#x3D;&gt; <code>sub_113A8</code> ; IRP_MJ_READ<br><code>MajorFunction[14]</code> &#x3D;&gt; <code>sub_110AC</code> ; IRP_MJ_DEVICE_CONTROL<br><code>MajorFunction[22]</code> &#x3D;&gt; <code>sub_1510C</code> ; IRP_MJ_POWER<br><code>MajorFunction[27]</code> &#x3D;&gt; <code>sub_15098</code> ; IRP_MJ_PNP</p>
<p>然後剩下的代碼還設定了一個SymbolicLink <code>\DosDevices\OeKbdFilter</code> &#x3D;&gt; <code>\Device\DevOeKbdFilter</code> 讓用戶層訪問驅動，我猜測應該會控制甚麼時候要攔截鍵盤。</p>
<p>接著我們來看看處理鍵盤輸入的<code>sub_113A8</code> </p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">NTSTATUS __fastcall <span class="token function">sub_113A8</span><span class="token punctuation">(</span>PDEVICE_OBJECT <span class="token operator">*</span><span class="token operator">*</span>a1<span class="token punctuation">,</span> IRP <span class="token operator">*</span>a2<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  PDEVICE_OBJECT <span class="token operator">*</span>v2<span class="token punctuation">;</span> <span class="token comment">// rdi</span>
  <span class="token keyword">struct</span> <span class="token class-name">_IO_STACK_LOCATION</span> <span class="token operator">*</span>CurrentStackLocation<span class="token punctuation">;</span> <span class="token comment">// r11</span>

  v2 <span class="token operator">=</span> a1<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">memmove</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a2<span class="token operator">-></span>Tail<span class="token punctuation">.</span>Overlay<span class="token punctuation">.</span>CurrentStackLocation<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a2<span class="token operator">-></span>Tail<span class="token punctuation">.</span>Overlay<span class="token punctuation">.</span>CurrentStackLocation<span class="token punctuation">,</span> <span class="token number">0x48u</span>i64<span class="token punctuation">)</span><span class="token punctuation">;</span>
  CurrentStackLocation <span class="token operator">=</span> a2<span class="token operator">-></span>Tail<span class="token punctuation">.</span>Overlay<span class="token punctuation">.</span>CurrentStackLocation<span class="token punctuation">;</span>
  CurrentStackLocation<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>CompletionRoutine <span class="token operator">=</span> <span class="token punctuation">(</span>PIO_COMPLETION_ROUTINE<span class="token punctuation">)</span>sub_111C4<span class="token punctuation">;</span>
  CurrentStackLocation<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Context <span class="token operator">=</span> a1<span class="token punctuation">;</span>
  CurrentStackLocation<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Control <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">32</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">IofCallDriver</span><span class="token punctuation">(</span><span class="token operator">*</span>v2<span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這段代碼設定了一個IRP完成回調，指向<code>sub_111C4</code>，也就是這個IRP_MJ_READ運行完後，再讓系統執行<code>sub_111C4</code>。</p>
<p>這麼做的原因是因為當我們在進行輸入的時候，要盡可能地縮小延遲，也就是說不要在IRP_MJ_READ裡放一堆花時間的代碼，這樣打字才不會有延遲。<br>所以這裡設定一個IRP完成回調的用意就是不耽誤IRP的傳遞，然後又可以執行<code>sub_111C4</code>，這樣一舉兩得。</p>
<p>我們回到上面的代碼，我們發現IRP完成回調指向<code>sub_111C4</code>，也就是裡面應該放了處理輸入的代碼，所以我們還看看<code>sub_111C4</code>的代碼:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">__int64 __fastcall <span class="token function">sub_111C4</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  __int64 v2<span class="token punctuation">;</span> <span class="token comment">// rbx</span>
  __int64 v3<span class="token punctuation">;</span> <span class="token comment">// r13</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment">// r12d</span>
  <span class="token keyword">unsigned</span> __int64 v5<span class="token punctuation">;</span> <span class="token comment">// rbp</span>
  __int64 v6<span class="token punctuation">;</span> <span class="token comment">// rdi</span>
  __int64 v7<span class="token punctuation">;</span> <span class="token comment">// rsi</span>
  KIRQL v8<span class="token punctuation">;</span> <span class="token comment">// r14</span>

  v2 <span class="token operator">=</span> a2<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a2 <span class="token operator">+</span> <span class="token number">48</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    v3 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a2 <span class="token operator">+</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    v4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    v5 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a2 <span class="token operator">+</span> <span class="token number">56</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">0xCu</span>i64<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      v6 <span class="token operator">=</span> <span class="token number">0</span>i64<span class="token punctuation">;</span>
      v7 <span class="token operator">=</span> v3 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span>
        v8 <span class="token operator">=</span> <span class="token function">KeAcquireSpinLockRaiseToDpc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>SpinLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>dword_13110 <span class="token punctuation">)</span>
          <span class="token keyword">goto</span> LABEL_38<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> dword_13110 <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span> dword_13110 <span class="token operator">==</span> <span class="token number">2</span> <span class="token punctuation">)</span>
          <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">==</span> <span class="token number">28</span>
              <span class="token operator">||</span> <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">==</span> <span class="token number">29</span>
              <span class="token operator">||</span> <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">==</span> <span class="token number">42</span>
              <span class="token operator">||</span> <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">==</span> <span class="token number">54</span>
              <span class="token operator">||</span> <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">==</span> <span class="token number">56</span>
              <span class="token operator">||</span> <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">==</span> <span class="token number">87</span> <span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
              <span class="token keyword">goto</span> LABEL_39<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
LABEL_38<span class="token operator">:</span>
            <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> LABEL_39<span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span> dword_13110 <span class="token operator">!=</span> <span class="token number">3</span> <span class="token punctuation">)</span>
          <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> dword_13110 <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">sub_11414</span><span class="token punctuation">(</span>v3 <span class="token operator">+</span> <span class="token number">12</span> <span class="token operator">*</span> v6<span class="token punctuation">)</span> <span class="token punctuation">)</span>
              <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">DbgPrint</span><span class="token punctuation">(</span><span class="token string">"Current Keyboard state err"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> LABEL_39<span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">&lt;</span> <span class="token number">2u</span> <span class="token operator">||</span> <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">></span> <span class="token number">0xBu</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">&lt;</span> <span class="token number">0x10u</span> <span class="token operator">||</span> <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">></span> <span class="token number">0x19u</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">&lt;</span> <span class="token number">0x1Eu</span> <span class="token operator">||</span> <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">></span> <span class="token number">0x26u</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">&lt;</span> <span class="token number">0x2Cu</span> <span class="token operator">||</span> <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">></span> <span class="token number">0x32u</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">!=</span> <span class="token number">14</span>
            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">&lt;</span> <span class="token number">0x47u</span> <span class="token operator">||</span> <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">></span> <span class="token number">0x49u</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">&lt;</span> <span class="token number">0x4Bu</span> <span class="token operator">||</span> <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">></span> <span class="token number">0x4Du</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">&lt;</span> <span class="token number">0x4Fu</span> <span class="token operator">||</span> <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">></span> <span class="token number">0x52u</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">!=</span> <span class="token number">69</span>
            <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">!=</span> <span class="token number">28</span>
            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">!=</span> <span class="token number">29</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v7 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
          <span class="token punctuation">&#123;</span>
            <span class="token keyword">goto</span> LABEL_38<span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
LABEL_39<span class="token operator">:</span>
        <span class="token function">KeReleaseSpinLock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>SpinLock<span class="token punctuation">,</span> v8<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">++</span>v4<span class="token punctuation">;</span>
        v7 <span class="token operator">+=</span> <span class="token number">12</span>i64<span class="token punctuation">;</span>
        v6 <span class="token operator">=</span> v4<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">>=</span> v5 <span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
          v2 <span class="token operator">=</span> a2<span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v2 <span class="token operator">+</span> <span class="token number">65</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v2 <span class="token operator">+</span> <span class="token number">184</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3</span>i64<span class="token punctuation">)</span> <span class="token operator">|=</span> <span class="token number">1u</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v2 <span class="token operator">+</span> <span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這段代碼看上去超亂的，找了一下後，發現是<code>a2</code>的類型是錯的，我們把它修正為<code>IRP</code>後，再手動改一下錯誤的地方，然後我們再來看看代碼:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">__int64 __fastcall <span class="token function">sub_111C4</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> IRP <span class="token operator">*</span>pIrp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  IRP <span class="token operator">*</span>v2<span class="token punctuation">;</span> <span class="token comment">// rbx</span>
  <span class="token keyword">struct</span> <span class="token class-name">_IRP</span> <span class="token operator">*</span>MasterIrp<span class="token punctuation">;</span> <span class="token comment">// r13</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment">// r12d</span>
  ULONG_PTR v5<span class="token punctuation">;</span> <span class="token comment">// rbp</span>
  __int64 v6<span class="token punctuation">;</span> <span class="token comment">// rdi</span>
  USHORT <span class="token operator">*</span>input_code<span class="token punctuation">;</span> <span class="token comment">// rsi</span>
  KIRQL v8<span class="token punctuation">;</span> <span class="token comment">// r14</span>

  v2 <span class="token operator">=</span> pIrp<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> pIrp<span class="token operator">-></span>IoStatus<span class="token punctuation">.</span>Status <span class="token operator">>=</span> <span class="token number">0</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    MasterIrp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">_IRP</span> <span class="token operator">*</span><span class="token punctuation">)</span>pIrp<span class="token operator">-></span>AssociatedIrp<span class="token punctuation">.</span>SystemBuffer<span class="token punctuation">;</span>
    v4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    v5 <span class="token operator">=</span> pIrp<span class="token operator">-></span>IoStatus<span class="token punctuation">.</span>Information <span class="token operator">/</span> <span class="token number">0xC</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      v6 <span class="token operator">=</span> <span class="token number">0</span>i64<span class="token punctuation">;</span>
      input_code <span class="token operator">=</span> <span class="token operator">&amp;</span>MasterIrp<span class="token operator">-></span>MakeCode<span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span>
        v8 <span class="token operator">=</span> <span class="token function">KeAcquireSpinLockRaiseToDpc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>SpinLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>dword_13110 <span class="token punctuation">)</span>
          <span class="token keyword">goto</span> LABEL_38<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> dword_13110 <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span> dword_13110 <span class="token operator">==</span> <span class="token number">2</span> <span class="token punctuation">)</span>
          <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span>input_code <span class="token operator">==</span> <span class="token number">28</span>
              <span class="token operator">||</span> <span class="token operator">*</span>input_code <span class="token operator">==</span> <span class="token number">29</span>
              <span class="token operator">||</span> <span class="token operator">*</span>input_code <span class="token operator">==</span> <span class="token number">42</span>
              <span class="token operator">||</span> <span class="token operator">*</span>input_code <span class="token operator">==</span> <span class="token number">54</span>
              <span class="token operator">||</span> <span class="token operator">*</span>input_code <span class="token operator">==</span> <span class="token number">56</span>
              <span class="token operator">||</span> <span class="token operator">*</span>input_code <span class="token operator">==</span> <span class="token number">87</span> <span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
              <span class="token keyword">goto</span> LABEL_39<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
LABEL_38<span class="token operator">:</span>
            <span class="token operator">*</span>input_code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> LABEL_39<span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span> dword_13110 <span class="token operator">!=</span> <span class="token number">3</span> <span class="token punctuation">)</span>
          <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> dword_13110 <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">sub_11414</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>MasterIrp <span class="token operator">+</span> <span class="token number">12</span> <span class="token operator">*</span> v6<span class="token punctuation">)</span> <span class="token punctuation">)</span>
              <span class="token operator">*</span>input_code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">DbgPrint</span><span class="token punctuation">(</span><span class="token string">"Current Keyboard state err"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> LABEL_39<span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token operator">*</span>input_code <span class="token operator">&lt;</span> <span class="token number">2u</span> <span class="token operator">||</span> <span class="token operator">*</span>input_code <span class="token operator">></span> <span class="token number">0xBu</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span>input_code <span class="token operator">&lt;</span> <span class="token number">0x10u</span> <span class="token operator">||</span> <span class="token operator">*</span>input_code <span class="token operator">></span> <span class="token number">0x19u</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span>input_code <span class="token operator">&lt;</span> <span class="token number">0x1Eu</span> <span class="token operator">||</span> <span class="token operator">*</span>input_code <span class="token operator">></span> <span class="token number">0x26u</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span>input_code <span class="token operator">&lt;</span> <span class="token number">0x2Cu</span> <span class="token operator">||</span> <span class="token operator">*</span>input_code <span class="token operator">></span> <span class="token number">0x32u</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>input_code <span class="token operator">!=</span> <span class="token number">14</span>
            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span>input_code <span class="token operator">&lt;</span> <span class="token number">0x47u</span> <span class="token operator">||</span> <span class="token operator">*</span>input_code <span class="token operator">></span> <span class="token number">0x49u</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span>input_code <span class="token operator">&lt;</span> <span class="token number">0x4Bu</span> <span class="token operator">||</span> <span class="token operator">*</span>input_code <span class="token operator">></span> <span class="token number">0x4Du</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span>input_code <span class="token operator">&lt;</span> <span class="token number">0x4Fu</span> <span class="token operator">||</span> <span class="token operator">*</span>input_code <span class="token operator">></span> <span class="token number">0x52u</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>input_code <span class="token operator">!=</span> <span class="token number">69</span>
            <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>input_code <span class="token operator">!=</span> <span class="token number">28</span>
            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span>input_code <span class="token operator">!=</span> <span class="token number">29</span> <span class="token operator">||</span> <span class="token punctuation">(</span>input_code<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
          <span class="token punctuation">&#123;</span>
            <span class="token keyword">goto</span> LABEL_38<span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
LABEL_39<span class="token operator">:</span>
        <span class="token function">KeReleaseSpinLock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>SpinLock<span class="token punctuation">,</span> v8<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">++</span>v4<span class="token punctuation">;</span>
        input_code <span class="token operator">+=</span> <span class="token number">6</span><span class="token punctuation">;</span>
        v6 <span class="token operator">=</span> v4<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">>=</span> v5 <span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
          v2 <span class="token operator">=</span> pIrp<span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v2<span class="token operator">-></span>PendingReturned <span class="token punctuation">)</span>
    v2<span class="token operator">-></span>Tail<span class="token punctuation">.</span>Overlay<span class="token punctuation">.</span>CurrentStackLocation<span class="token operator">-></span>Control <span class="token operator">|=</span> <span class="token number">1u</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>v2<span class="token operator">-></span>IoStatus<span class="token punctuation">.</span>Status<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>看上去總算是舒服多了… 那我們先來分析一下代碼吧。<br>這裡的<code>input_code</code>代表是鍵盤的輸入值，也就是<code>pIrp-&gt;AssociatedIrp.SystemBuffer-&gt;MakeCode</code>，然後還有一個變數<code>dword_13110</code>在這裡則是控制攔截的模式<br>我們來看看當<code>dword_13110</code>等於甚麼的時候會做甚麼事:<br><code>dword_13110</code> &#x3D;&#x3D; 0 &#x3D;&gt; 禁用所有輸入<br><code>dword_13110</code> &#x3D;&#x3D; 1 &#x3D;&gt; 放行所有輸入<br><code>dword_13110</code> &#x3D;&#x3D; 2 &#x3D;&gt; 禁用除了功能鍵之外的所有輸入<br><code>dword_13110</code> &#x3D;&#x3D; 3 &#x3D;&gt; 禁用除了與密碼有關之外的所有輸入<br><code>dword_13110</code> &#x3D;&#x3D; 4 &#x3D;&gt; 禁用除了與密碼有關和中文之外的所有輸入</p>
<p>那問題來了，<code>dword_13110</code>在哪裡變更?<br>所以我把目光喵到了<code>sub_110AC</code>，也就是處理IRP_MJ_DEVICE_CONTROL的函數:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">NTSTATUS __fastcall <span class="token function">sub_110AC</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> IRP <span class="token operator">*</span>a2<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  DWORD LowPart<span class="token punctuation">;</span> <span class="token comment">// ebx</span>
  DWORD v5<span class="token punctuation">;</span> <span class="token comment">// ebx</span>
  KIRQL v6<span class="token punctuation">;</span> <span class="token comment">// si</span>
  DWORD v7<span class="token punctuation">;</span> <span class="token comment">// ebx</span>
  DWORD v8<span class="token punctuation">;</span> <span class="token comment">// ebx</span>
  DWORD v9<span class="token punctuation">;</span> <span class="token comment">// ebx</span>
  <span class="token keyword">const</span> CHAR <span class="token operator">*</span>v11<span class="token punctuation">;</span> <span class="token comment">// rcx</span>

  LowPart <span class="token operator">=</span> a2<span class="token operator">-></span>Tail<span class="token punctuation">.</span>Overlay<span class="token punctuation">.</span>CurrentStackLocation<span class="token operator">-></span>Parameters<span class="token punctuation">.</span>Read<span class="token punctuation">.</span>ByteOffset<span class="token punctuation">.</span>LowPart<span class="token punctuation">;</span><span class="token comment">// 獲取控制代碼</span>
  <span class="token function">DbgPrint</span><span class="token punctuation">(</span>aKfdispatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">DbgPrint</span><span class="token punctuation">(</span><span class="token string">"loc->Parameters.DeviceIoControl.IoControlCode = 0x%x"</span><span class="token punctuation">,</span> LowPart<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v5 <span class="token operator">=</span> LowPart <span class="token operator">-</span> <span class="token number">729092</span><span class="token punctuation">;</span>
  v6 <span class="token operator">=</span> <span class="token function">KeAcquireSpinLockRaiseToDpc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>SpinLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v5 <span class="token punctuation">)</span>                                    <span class="token comment">// 禁用鍵盤的所有輸入</span>
  <span class="token punctuation">&#123;</span>
    v11 <span class="token operator">=</span> <span class="token string">"KEYBOARD_ALL_DISALE"</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> LABEL_12<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  v7 <span class="token operator">=</span> v5 <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v7 <span class="token punctuation">)</span>                                    <span class="token comment">// 放行鍵盤的所有輸入</span>
  <span class="token punctuation">&#123;</span>
    dword_13110 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">DbgPrint</span><span class="token punctuation">(</span><span class="token string">"KEYBOARD_ALL_RELEASE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> LABEL_13<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  v8 <span class="token operator">=</span> v7 <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v8 <span class="token punctuation">)</span>                                    <span class="token comment">// 除了功能鍵之外的所有輸入都禁用</span>
  <span class="token punctuation">&#123;</span>
    v11 <span class="token operator">=</span> <span class="token string">"KEYBOARD_ALL_DISALE_EXCEPT_CTRLENTER"</span><span class="token punctuation">;</span>
LABEL_12<span class="token operator">:</span>
    dword_13110 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token function">DbgPrint</span><span class="token punctuation">(</span>v11<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> LABEL_13<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  v9 <span class="token operator">=</span> v8 <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v9 <span class="token punctuation">)</span>                                     <span class="token comment">// 除了密碼和中文以外的輸入都禁用</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v9 <span class="token operator">!=</span> <span class="token number">4</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">KeReleaseSpinLock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>SpinLock<span class="token punctuation">,</span> v6<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">sub_15198</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    dword_13110 <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token function">DbgPrint</span><span class="token punctuation">(</span><span class="token string">"KEYBOARD_ALL_DISALE_EXCEPT_PASSWORD_AND_CHINESE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span>                                          <span class="token comment">// 除了密碼以外的輸入都禁用</span>
  <span class="token punctuation">&#123;</span>
    dword_13110 <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token function">DbgPrint</span><span class="token punctuation">(</span><span class="token string">"KEYBOARD_ALL_DISALE_EXCEPT_PASSWORD"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
LABEL_13<span class="token operator">:</span>
  <span class="token function">KeReleaseSpinLock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>SpinLock<span class="token punctuation">,</span> v6<span class="token punctuation">)</span><span class="token punctuation">;</span>
  a2<span class="token operator">-></span>IoStatus<span class="token punctuation">.</span>Status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">IofCompleteRequest</span><span class="token punctuation">(</span>a2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這段代碼功能就是控制<code>dword_13110</code>的值，然後透過控制代碼來調整<code>dword_13110</code>的值並執行相對應的動作<br>然後上面的<code> - 4</code>應該是在算偏移值。</p>
<p>至此，我們已經大致了解了ITBC怎麼禁用鍵盤輸入<br>但我們還不知道ITBC怎麼是禁用滑鼠，甚至還有是誰發送控制代碼給驅動都不知道，我們留到下篇來講。</p>

  </div>

  
    
  <div class="sea-prev-next-wrapper">
    
      <div class="prev">
        <span><</span>
        <a class="link" href="/2024/12/22/ITBC-13-%E5%8A%AB%E6%8C%81%E9%8D%B5%E7%9B%A4%E5%92%8C%E6%BB%91%E9%BC%A0%E5%88%86%E6%9E%90-%E4%B8%8B/">
          ITBC 13 劫持鍵盤和滑鼠分析 (下)
        </a>
      </div>
    
    
      <div class="next">
        <a class="link" href="/2024/12/19/A%E7%B5%84%E4%BD%9C%E6%A5%AD8/">
          A組作業8
        </a>
        <span>></span>
      </div>
    
  </div>

  
</article>


  </main>
  <footer id="sea-footer-container">
  <div class="sea-footer-row">
    <div class="sea-footer-menu-link">
      
    </div>
  </div>
  
  
  <div class="sea-footer-row">
    <div class="sea-footer-copyright">
      <span>©</span>
      
        2024
      
      <span>·</span>
      mtkiao
    </div>
    <span class="split-line">|</span>
    <div class="sea-footer-theme-by">
      Theme by <a class="theme" href="https://github.com/hai-zou/hexo-theme-sea" target="_blank">Sea</a>
    </div>
  </div>
</footer>

  
<script src="/js/main.js"></script>


<script src="/js/theme.js"></script>

</body>
</html>